<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>MALIQ ‚Äî Akƒ±llƒ± Maliyet Hesaplayƒ±cƒ±nƒ±z</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap">
<style>
:root{
  --bg:#061322; --card:#071526; --accent1:#06b6d4; --accent2:#7c3aed; --muted:#9fb0c6;
  --surface: rgba(255,255,255,0.02); --btn-grad: linear-gradient(90deg,var(--accent1),var(--accent2));
  --radius:12px; --font:Inter,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;
}
*{box-sizing:border-box;font-family:var(--font)}
html,body{height:100%;margin:0;background:linear-gradient(180deg,var(--bg),#04111a);color:#eaf4ff}
.container{max-width:720px;margin:0 auto;padding:10px}
.header-row{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
.brand{display:flex;gap:8px;align-items:center}
.logo img{width:40px;height:40px;border-radius:8px}
.title{font-weight:800;font-size:16px}
.search-wrap-centered{width:100%;display:flex;justify-content:center;margin:6px 0 10px 0;position:relative}
.search{display:flex;align-items:center;gap:8px;padding:8px 12px;border-radius:14px;background:var(--surface);border:1px solid rgba(255,255,255,0.03);width:100%;max-width:680px;position:relative}
.search input{flex:1;background:transparent;border:0;color:inherit;padding:6px 10px;font-size:14px;outline:none}
.search-overlay{position:absolute;left:50%;top:48%;transform:translate(-50%,-4px);pointer-events:none;color:rgba(255,255,255,0.92);font-size:14px;transition:opacity .22s,transform .22s;white-space:nowrap}
.search-overlay.fade{opacity:0;transform:translate(-50%,-12px)}
.tabs{display:flex;gap:6px;margin:10px 0}
.tab{flex:1;padding:10px;border-radius:12px;text-align:center;background:transparent;color:var(--muted);cursor:pointer;border:1px solid rgba(255,255,255,0.03);font-weight:800;display:flex;align-items:center;justify-content:center;font-size:12px}
.tab.active{background:var(--btn-grad);color:#021026;box-shadow:0 6px 20px rgba(2,6,23,0.5)}
.section{background:var(--card);border-radius:12px;padding:10px;border:1px solid rgba(255,255,255,0.03);margin-bottom:10px}

/* cards - keep unified style and use .card-btn for both categories and products */
.card-btn{background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005));padding:10px;border-radius:10px;text-align:center;cursor:pointer;border:1px solid rgba(255,255,255,0.03);transition:transform .12s,box-shadow .12s;display:flex;flex-direction:column;gap:6px;align-items:center;justify-content:center;min-height:70px}
.card-btn .emoji{font-size:20px}
.card-btn .name{font-weight:800;font-size:12px;color:inherit}
.card-btn:hover{transform:translateY(-2px);box-shadow:0 6px 18px rgba(3,10,30,0.45)}

.categories-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
@media(min-width:520px){.categories-grid{grid-template-columns:repeat(4,1fr)}}
.products-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:8px;margin-top:10px}
@media(min-width:520px){.products-grid{grid-template-columns:repeat(3,1fr)}}

/* calculation rows */
.calc-grid{display:flex;flex-direction:column;gap:6px;margin-top:8px}
.material-item{background:var(--surface);padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);display:flex;flex-direction:column;gap:6px}
.material-top{display:flex;align-items:center;gap:6px}
.material-emoji{width:32px;text-align:center}
.row-controls{display:flex;gap:6px;align-items:center;flex-wrap:nowrap;justify-content:space-between}
.left-controls{display:flex;gap:8px;align-items:center;min-width:0}
.right-controls{display:flex;gap:6px;align-items:center;justify-content:flex-end;min-width:220px;flex-shrink:0}
.input-small{padding:6px;border-radius:8px;border:0;background:rgba(255,255,255,0.02);color:inherit;font-size:13px}
.unit-select{padding:6px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit;font-size:13px}
.cost-amount{font-weight:900;color:var(--accent1);min-width:70px;text-align:right;font-size:13px}
.total-row{display:flex;justify-content:space-between;align-items:center;padding:8px;border-radius:8px;background:linear-gradient(90deg, rgba(6,182,212,0.04), rgba(124,58,237,0.02));font-weight:900;margin-top:6px;font-size:14px}
.saved-list{display:flex;flex-direction:column;gap:6px}
.saved-item{background:var(--surface);padding:6px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);font-size:13px;display:flex;flex-direction:column;gap:4px}

.preview-modal{position:fixed;inset:0;background:rgba(0,0,0,0.75);display:none;align-items:center;justify-content:center;z-index:80}
.preview-card{background:#fff;padding:10px;border-radius:8px;color:#000;width:95%;max-width:760px;height:85vh;display:flex;flex-direction:column}
.preview-toolbar{display:flex;justify-content:space-between;align-items:center;gap:6px;margin-bottom:6px}
.preview-canvas{flex:1;overflow:auto;background:#fff;border-radius:6px;padding:6px;display:flex;align-items:center;justify-content:center}
.modal{position:fixed;inset:0;background:rgba(0,0,0,0.75);display:none;align-items:center;justify-content:center;z-index:60}
.modal-content{background:var(--card);padding:10px;border-radius:8px;width:95%;max-width:400px}
.btn-primary{padding:8px 12px;border-radius:10px;background:var(--btn-grad);color:#021026;border:0;font-weight:800;cursor:pointer;font-size:13px}
.btn-ghost{padding:6px 10px;border-radius:10px;background:transparent;color:var(--muted);border:1px solid rgba(255,255,255,0.06);cursor:pointer;font-size:12px}
.footer{margin-top:10px;text-align:center;color:var(--muted);font-size:11px}
.small-note{color:var(--muted);font-size:12px}

/* Developer Mode Styles */
.dev-tools{display:none}
.dev-section{background:var(--surface);padding:10px;border-radius:10px;margin-bottom:10px}
.dev-section-title{font-weight:800;margin-bottom:6px;color:var(--accent1);font-size:14px}
.dev-controls{display:flex;flex-wrap:wrap;gap:6px;margin-top:6px}
.dev-input{flex:1;min-width:150px}
.dev-btn{padding:6px 10px;border-radius:8px;background:var(--btn-grad);color:#021026;border:0;font-weight:600;cursor:pointer;font-size:12px}
.dev-btn-secondary{padding:6px 10px;border-radius:8px;background:transparent;color:var(--muted);border:1px solid rgba(255,255,255,0.06);cursor:pointer;font-size:12px}
.dev-stats{display:grid;grid-template-columns:repeat(2,1fr);gap:6px}
.dev-stat{background:var(--surface);padding:8px;border-radius:8px;text-align:center}
.dev-stat-value{font-weight:800;font-size:16px;color:var(--accent1)}
.dev-stat-label{font-size:11px;color:var(--muted)}

/* Search Suggestions */
.search-suggestions{position:absolute;top:100%;left:0;right:0;background:var(--card);border-radius:10px;border:1px solid rgba(255,255,255,0.03);margin-top:4px;max-height:250px;overflow-y:auto;z-index:50;display:none;box-shadow:0 8px 24px rgba(0,0,0,0.3)}
.search-suggestion-item{padding:8px 12px;cursor:pointer;display:flex;align-items:center;gap:8px;border-bottom:1px solid rgba(255,255,255,0.03);font-size:13px}
.search-suggestion-item:last-child{border-bottom:none}
.search-suggestion-item:hover{background:var(--surface)}
.search-suggestion-emoji{font-size:16px}
.search-suggestion-name{font-weight:600}

/* Nested Categories */
.nested-categories{margin-top:10px;display:none;grid-template-columns:repeat(3,1fr);gap:8px}
.nested-categories.active{display:grid}
@media(min-width:520px){.nested-categories{grid-template-columns:repeat(4,1fr)}}

/* Quick Add Modal */
.quick-add-textarea{min-height:300px;font-family:monospace;font-size:12px;line-height:1.4}

/* Mobile optimizations */
@media (max-width: 480px) {
  .container{padding:8px}
  .tab{padding:8px;font-size:11px}
  .card-btn{min-height:60px;padding:8px}
  .categories-grid{grid-template-columns:repeat(3,1fr);gap:6px}
  .products-grid{grid-template-columns:repeat(2,1fr);gap:6px}
  .row-controls{flex-direction:column;align-items:stretch;gap:8px}
  .left-controls, .right-controls{min-width:auto;justify-content:space-between}
  .dev-controls{flex-direction:column}
  .dev-input{min-width:auto}
}
</style>
</head>
<body>
  <div class="container" role="application" aria-label="MALIQ">
    <div class="header-row">
      <div class="brand">
        <div class="logo"><img src="https://i.hizliresim.com/sis5uti.png" alt="logo"></div>
        <div><div class="title">Akƒ±llƒ± Maliyet Hesaplayƒ±cƒ±nƒ±z</div></div>
      </div>
      <div style="display:flex;gap:6px;align-items:center">
        <div style="width:32px;height:32px;border-radius:6px;background:rgba(255,255,255,0.04);display:flex;align-items:center;justify-content:center" id="userAvatar">G</div>
        <div style="font-weight:700;font-size:13px" id="userName">Geli≈ütirici</div>
      </div>
    </div>

    <div class="search-wrap-centered">
      <div class="search" role="search" aria-label="Yemek ara">
        <input id="searchInput" placeholder="" autocomplete="off" />
        <div id="searchOverlay" class="search-overlay">Lahmacun</div>
      </div>
      <div id="searchSuggestions" class="search-suggestions"></div>
    </div>

    <nav class="tabs" role="tablist">
      <div id="tabCategories" class="tab active">KATEGORƒ∞LER</div>
      <div id="tabProducts" class="tab">√úR√úNLER</div>
      <div id="tabCalc" class="tab">HESAPLAMA</div>
      <div id="tabSaved" class="tab">KAYITLAR</div>
      <div id="tabDev" class="tab" style="display:none">GELƒ∞≈ûTƒ∞Rƒ∞Cƒ∞</div>
    </nav>

    <main>
      <section id="screenCategories" class="section">
        <div style="font-weight:900;margin-bottom:6px;font-size:14px">Yemek √áe≈üitleri</div>
        <div id="categoriesGrid" class="categories-grid"></div>
        <div id="nestedCategories" class="nested-categories"></div>
      </section>

      <section id="screenProducts" class="section" style="display:none">
        <div style="font-weight:900;margin-bottom:6px;font-size:14px" id="productsTitle">Se√ßilen Kategori: T√ºm√º</div>
        <div id="productsGrid" class="products-grid"></div>
      </section>

      <section id="screenCalc" class="section" style="display:none">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
          <div>
            <div style="font-weight:900;font-size:14px" id="calcTitle">Hesaplama</div>
            <div id="calcSubtitle" class="small-note"></div>
          </div>
          <div style="display:flex;gap:6px;align-items:center">
            <input id="calcName" class="input-small" placeholder="√úr√ºn adƒ±" style="width:100px" />
            <button id="saveBtn" class="btn-primary">Kaydet</button>
            <button id="clearBtn" class="btn-ghost">Temizle</button>
          </div>
        </div>

        <div id="materialsList" class="calc-grid"></div>

        <div class="total-row" id="totalRow" style="display:none">
          <div>Toplam Maliyet</div>
          <div id="totalCost" class="cost-amount">0.00 ‚Ç∫</div>
        </div>

        <div style="margin-top:8px;display:flex;gap:6px">
          <button id="addMaterialBtn" class="btn-ghost">+ Malzeme Ekle</button>
          <button id="exportBtn" class="btn-primary">PDF √ñnizleme</button>
        </div>
      </section>

      <section id="screenSaved" class="section" style="display:none">
        <div style="font-weight:900;margin-bottom:6px;font-size:14px">Maliyet Tablom</div>
        <div id="savedList" class="saved-list"></div>
      </section>

      <!-- Developer Tools Section -->
      <section id="screenDev" class="section dev-tools" style="display:none">
        <div style="font-weight:900;margin-bottom:6px;color:var(--accent1);font-size:14px">Geli≈ütirici Se√ßenekleri</div>
        
        <!-- Visitor Statistics -->
        <div class="dev-section">
          <div class="dev-section-title">Ziyaret√ßi ƒ∞statistikleri</div>
          <div class="dev-stats">
            <div class="dev-stat">
              <div class="dev-stat-value" id="totalVisits">0</div>
              <div class="dev-stat-label">Toplam Ziyaret</div>
            </div>
            <div class="dev-stat">
              <div class="dev-stat-value" id="uniqueVisitors">0</div>
              <div class="dev-stat-label">Benzersiz Ziyaret√ßi</div>
            </div>
            <div class="dev-stat">
              <div class="dev-stat-value" id="devLogins">0</div>
              <div class="dev-stat-label">Geli≈ütirici Giri≈üi</div>
            </div>
            <div class="dev-stat">
              <div class="dev-stat-value" id="savedCalculations">0</div>
              <div class="dev-stat-label">Kayƒ±tlƒ± Hesaplama</div>
            </div>
          </div>
        </div>
        
        <!-- Category Management -->
        <div class="dev-section">
          <div class="dev-section-title">Kategori Y√∂netimi</div>
          <div class="dev-controls">
            <input type="text" id="newCategoryName" class="dev-input input-small" placeholder="Kategori Adƒ±">
            <input type="text" id="newCategoryEmoji" class="input-small" placeholder="Emoji" style="width:70px">
            <select id="parentCategorySelect" class="unit-select">
              <option value="">Ana Kategori</option>
            </select>
            <button id="addCategoryBtn" class="dev-btn">Kategori Ekle</button>
          </div>
          <div class="dev-controls">
            <button id="exportCategoriesBtn" class="dev-btn-secondary">Kategorileri Dƒ±≈üa Aktar</button>
            <button id="importCategoriesBtn" class="dev-btn-secondary">Kategorileri ƒ∞√ße Aktar</button>
          </div>
        </div>
        
        <!-- Product Management -->
        <div class="dev-section">
          <div class="dev-section-title">√úr√ºn Y√∂netimi</div>
          <div class="dev-controls">
            <input type="text" id="newProductName" class="dev-input input-small" placeholder="√úr√ºn Adƒ±">
            <input type="text" id="newProductEmoji" class="input-small" placeholder="Emoji" style="width:70px">
            <select id="productCategorySelect" class="unit-select">
              <option value="">Kategori Se√ß</option>
            </select>
            <button id="addProductBtn" class="dev-btn">√úr√ºn Ekle</button>
          </div>
          <div class="dev-controls">
            <button id="quickAddProductsBtn" class="dev-btn-secondary">Hƒ±zlƒ± √úr√ºn Ekle</button>
            <button id="exportProductsBtn" class="dev-btn-secondary">√úr√ºnleri Dƒ±≈üa Aktar</button>
            <button id="importProductsBtn" class="dev-btn-secondary">√úr√ºnleri ƒ∞√ße Aktar</button>
          </div>
        </div>
        
        <!-- Data Management -->
        <div class="dev-section">
          <div class="dev-section-title">Veri Y√∂netimi</div>
          <div class="dev-controls">
            <button id="exportAllDataBtn" class="dev-btn">T√ºm Veriyi Dƒ±≈üa Aktar</button>
            <button id="importAllDataBtn" class="dev-btn-secondary">T√ºm Veriyi ƒ∞√ße Aktar</button>
            <button id="resetDataBtn" class="dev-btn-secondary" style="background:#ff6b6b">Verileri Sƒ±fƒ±rla</button>
          </div>
        </div>
      </section>
    </main>

    <div class="footer">CAN&D ≈ûirketinin √ºr√ºn√ºd√ºr. T√ºm haklarƒ± saklƒ±dƒ±r ¬© CAN&D</div>
  </div>

  <div id="previewModal" class="preview-modal" aria-hidden="true">
    <div class="preview-card">
      <div class="preview-toolbar">
        <div id="previewTitle" style="font-weight:800">√ñnizleme</div>
        <div style="display:flex;gap:6px">
          <button id="downloadPreviewBtn" class="btn-primary">PDF ƒ∞ndir</button>
          <button id="closePreviewBtn" class="btn-ghost">Kapat</button>
        </div>
      </div>
      <div id="previewCanvas" class="preview-canvas"><div style="color:#666">√ñnizleme hazƒ±rlanƒ±yor...</div></div>
    </div>
  </div>

  <div id="addModal" class="modal" aria-hidden="true">
    <div class="modal-content">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
        <div style="font-weight:900">Malzeme Ekle</div>
        <button id="closeAddModal" class="btn-ghost">Kapat</button>
      </div>
      <div style="display:flex;flex-direction:column;gap:6px">
        <input id="addName" class="input-small" placeholder="Malzeme adƒ±" />
        <div style="display:flex;gap:6px">
          <input id="addQty" type="number" class="input-small" value="100" />
          <select id="addUnit" class="unit-select">
            <option value="gr">gr</option><option value="kg">kg</option><option value="ml">ml</option><option value="lt">lt</option><option value="adet">adet</option>
          </select>
        </div>
        <div style="display:flex;gap:6px">
          <select id="addPriceUnit" class="unit-select">
            <option value="kg">‚Ç∫ / kg</option><option value="gr">‚Ç∫ / gr</option><option value="lt">‚Ç∫ / lt</option><option value="ml">‚Ç∫ / ml</option><option value="adet">‚Ç∫ / adet</option><option value="koli">‚Ç∫ / koli</option>
          </select>
          <input id="addPrice" type="number" class="input-small" placeholder="Fiyat" step="0.01" />
        </div>
        <div id="addKoliRow" style="display:none">
          <input id="addKoliSize" type="number" class="input-small" placeholder="Koli adeti" min="1" />
        </div>
        <div style="display:flex;gap:6px">
          <button id="confirmAdd" class="btn-primary">Ekle</button>
          <button id="cancelAdd" class="btn-ghost">ƒ∞ptal</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Quick Add Modal -->
  <div id="quickAddModal" class="modal" aria-hidden="true">
    <div class="modal-content">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
        <div style="font-weight:900">Hƒ±zlƒ± √úr√ºn Ekle</div>
        <button id="closeQuickAddModal" class="btn-ghost">Kapat</button>
      </div>
      <div style="display:flex;flex-direction:column;gap:6px">
        <div class="small-note">+ i≈üareti kategori, - i≈üareti √ºr√ºn ekler. Malzemeleri √ºr√ºn altƒ±na yazƒ±n.</div>
        <div class="small-note" style="color:var(--accent1)">√ñrnek:<br>+üç≥ YUMURTA √áE≈ûƒ∞TLERƒ∞<br>-üå∂Ô∏è Sucuklu Yumurta<br>üå∂Ô∏è Sucuk: 120 gr<br>ü•ö Yumurta: 3 adet</div>
        <textarea id="quickProductsText" class="input-small quick-add-textarea" placeholder="Buraya verileri yapƒ±≈ütƒ±rƒ±n..." style="resize:vertical"></textarea>
        <select id="quickAddCategorySelect" class="unit-select">
          <option value="">Mevcut Kategori Se√ß (isteƒüe baƒülƒ±)</option>
        </select>
        <div style="display:flex;gap:6px">
          <button id="confirmQuickAdd" class="btn-primary">Ekle</button>
          <button id="cancelQuickAdd" class="btn-ghost">ƒ∞ptal</button>
        </div>
      </div>
    </div>
  </div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
// URL parametrelerini kontrol et
const urlParams = new URLSearchParams(window.location.search);
const isAdmin = urlParams.get('admin') === 'true' || localStorage.getItem('maliq_admin') === 'true';

// Admin durumunu localStorage'a kaydet
if (isAdmin) {
  localStorage.setItem('maliq_admin', 'true');
}

/* Data */
const RECIPES = {
  "Lahmacun": { category:'lahmacun', emoji:'ü•ô', ingredients:[{name:'Un',qty:150,unit:'gr',emoji:'üåæ'},{name:'Kƒ±yma',qty:150,unit:'gr',emoji:'ü•©'}]},
  "Adana D√ºr√ºm": { category:'durum', emoji:'üåØ', ingredients:[{name:'Kuzu Kƒ±ymasƒ±',qty:200,unit:'gr',emoji:'ü•©'},{name:'Lava≈ü',qty:1,unit:'adet',emoji:'ü´ì'}]},
  "Pizza Margherita": { category:'pizza', emoji:'üçï', ingredients:[{name:'Un',qty:300,unit:'gr',emoji:'üåæ'},{name:'Mozzarella',qty:150,unit:'gr',emoji:'üßÄ'}]},
  "Hamburger": { category:'fast', emoji:'üçî', ingredients:[{name:'K√∂fte',qty:150,unit:'gr',emoji:'ü•©'},{name:'Ekmek',qty:1,unit:'adet',emoji:'üçû'}]},
  "Cola": { category:'icecek', emoji:'ü•§', ingredients:[{name:'Cola',qty:330,unit:'ml',emoji:'ü•§'}]},
  "≈ûalgam": { category:'icecek', emoji:'üßÉ', ingredients:[{name:'≈ûalgam',qty:330,unit:'ml',emoji:'üßÉ'}]}
};

let currentProduct = null;
let calcItems = [];
let savedListArr = JSON.parse(localStorage.getItem('maliq_saved')||'[]');

/* Developer Mode Variables */
let visitorStats = JSON.parse(localStorage.getItem('maliq_stats')||'{"totalVisits":0,"uniqueVisitors":0,"devLogins":0,"lastVisit":null}');

/* Nested Categories */
let CATEGORIES = JSON.parse(localStorage.getItem('maliq_categories')||'[]');
if (CATEGORIES.length === 0) {
  // Initialize with default categories
  CATEGORIES = [
    { id: 'kahvalti', name: 'Kahvaltƒ±', emoji: 'ü•ê', parentId: null },
    { id: 'corba', name: '√áorba', emoji: 'ü•£', parentId: null },
    { id: 'ana', name: 'Ana Yemek', emoji: 'üçΩÔ∏è', parentId: null },
    { id: 'pide', name: 'Pide', emoji: 'ü•ô', parentId: null },
    { id: 'lahmacun', name: 'Lahmacun', emoji: 'ü•ô', parentId: null },
    { id: 'pizza', name: 'Pizza', emoji: 'üçï', parentId: null },
    { id: 'durum', name: 'D√ºr√ºm', emoji: 'üåØ', parentId: null },
    { id: 'fast', name: 'Fast Food', emoji: 'üçî', parentId: null },
    { id: 'icecek', name: 'ƒ∞√ßecek', emoji: 'ü•§', parentId: null },
    { id: 'tatli', name: 'Tatlƒ±', emoji: 'üç®', parentId: null },
    { id: 'garnitur', name: 'Garnit√ºr', emoji: 'üçü', parentId: null },
    { id: 'deniz', name: 'Deniz', emoji: 'üêü', parentId: null },
    { id: 'vegan', name: 'Vejetaryen', emoji: 'ü•ó', parentId: null }
  ];
  localStorage.setItem('maliq_categories', JSON.stringify(CATEGORIES));
}

// Admin ise geli≈ütirici sekmesini g√∂ster
if (isAdmin) {
  document.getElementById('tabDev').style.display = 'flex';
  document.getElementById('userName').textContent = 'Geli≈ütirici';
  document.getElementById('userAvatar').textContent = 'G';
} else {
  document.getElementById('userName').textContent = 'Misafir';
  document.getElementById('userAvatar').textContent = 'M';
}

/* Search Animation */
let allProductNames = Object.keys(RECIPES);
let rotIndex = 0, rotTimer = null;
const searchOverlay = document.getElementById('searchOverlay');
const searchInput = document.getElementById('searchInput');
const searchSuggestions = document.getElementById('searchSuggestions');

function updateProductNames() {
  allProductNames = Object.keys(RECIPES);
}

function rotateOnce(){ 
  if(!searchOverlay || allProductNames.length === 0) return; 
  searchOverlay.classList.add('fade'); 
  setTimeout(()=>{ 
    rotIndex = (rotIndex + 1) % allProductNames.length; 
    searchOverlay.textContent = allProductNames[rotIndex]; 
    searchOverlay.classList.remove('fade'); 
  }, 220); 
}

function startRot(){ 
  if(rotTimer || allProductNames.length === 0) return; 
  rotTimer = setInterval(rotateOnce, 2000); 
}

function stopRot(){ 
  if(!rotTimer) return; 
  clearInterval(rotTimer); 
  rotTimer = null; 
}

if(allProductNames.length) {
  searchOverlay.textContent = allProductNames[0];
  startRot();
}

/* Search Suggestions */
searchInput.addEventListener('input', (e)=>{ 
  const v = e.target.value || ''; 
  if(v.length > 0){ 
    stopRot(); 
    searchOverlay.style.opacity = '0'; 
    searchOverlay.style.transform = 'translate(-50%,-12px)'; 
    
    // Show suggestions
    const q = v.trim().toLowerCase();
    if(!q) {
      searchSuggestions.style.display = 'none';
      return;
    }
    
    let matches = allProductNames.filter(k => k.toLowerCase().includes(q));
    if(matches.length === 0) {
      searchSuggestions.style.display = 'none';
      return;
    }
    
    searchSuggestions.innerHTML = '';
    matches.slice(0, 10).forEach(m => {
      const item = document.createElement('div');
      item.className = 'search-suggestion-item';
      item.innerHTML = `
        <div class="search-suggestion-emoji">${RECIPES[m].emoji || 'üçΩÔ∏è'}</div>
        <div class="search-suggestion-name">${m}</div>
      `;
      item.addEventListener('click', () => {
        searchInput.value = '';
        searchSuggestions.style.display = 'none';
        openCalcFor(m);
        setActiveTab('calc');
      });
      searchSuggestions.appendChild(item);
    });
    
    searchSuggestions.style.display = 'block';
  } else { 
    searchOverlay.style.opacity = '1'; 
    searchOverlay.style.transform = 'translate(-50%,-4px)'; 
    startRot(); 
    searchSuggestions.style.display = 'none';
  }
});

// Close suggestions when clicking outside
document.addEventListener('click', (e) => {
  if (!e.target.closest('.search-wrap-centered')) {
    searchSuggestions.style.display = 'none';
  }
});

/* Helpers & renderers */
function setActiveTab(tab){
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  if(tab === 'categories') document.getElementById('tabCategories').classList.add('active');
  if(tab === 'products') document.getElementById('tabProducts').classList.add('active');
  if(tab === 'calc') document.getElementById('tabCalc').classList.add('active');
  if(tab === 'saved') document.getElementById('tabSaved').classList.add('active');
  if(tab === 'dev') document.getElementById('tabDev').classList.add('active');
  
  document.getElementById('screenCategories').style.display = tab === 'categories' ? 'block' : 'none';
  document.getElementById('screenProducts').style.display = tab === 'products' ? 'block' : 'none';
  document.getElementById('screenCalc').style.display = tab === 'calc' ? 'block' : 'none';
  document.getElementById('screenSaved').style.display = tab === 'saved' ? 'block' : 'none';
  document.getElementById('screenDev').style.display = tab === 'dev' ? 'block' : 'none';
}

function renderCategories(){
  const container = document.getElementById('categoriesGrid'); 
  container.innerHTML = '';
  
  // Get top-level categories (with no parent)
  const topLevelCategories = CATEGORIES.filter(cat => !cat.parentId);
  
  topLevelCategories.forEach(cat => {
    const d = document.createElement('div'); 
    d.className = 'card-btn';
    d.innerHTML = `<div class="emoji">${cat.emoji}</div><div class="name">${cat.name}</div>`;
    d.addEventListener('click', () => { 
      // Show nested categories if any
      showNestedCategories(cat.id);
    });
    container.appendChild(d);
  });
}

function showNestedCategories(parentId) {
  const nestedContainer = document.getElementById('nestedCategories');
  nestedContainer.innerHTML = '';
  
  // Get child categories
  const childCategories = CATEGORIES.filter(cat => cat.parentId === parentId);
  
  if (childCategories.length > 0) {
    childCategories.forEach(cat => {
      const btn = document.createElement('div');
      btn.className = 'card-btn';
      btn.innerHTML = `<div class="emoji">${cat.emoji}</div><div class="name">${cat.name}</div>`;
      btn.addEventListener('click', () => {
        document.getElementById('productsTitle').textContent = `Se√ßilen Kategori: ${cat.name}`;
        renderProducts(cat.id);
        setActiveTab('products');
      });
      
      nestedContainer.appendChild(btn);
    });
    
    nestedContainer.classList.add('active');
  } else {
    // No child categories, show products directly
    const parentCategory = CATEGORIES.find(cat => cat.id === parentId);
    if (parentCategory) {
      document.getElementById('productsTitle').textContent = `Se√ßilen Kategori: ${parentCategory.name}`;
      renderProducts(parentId);
      setActiveTab('products');
    }
  }
}

function renderProducts(categoryKey){
  const container = document.getElementById('productsGrid'); 
  container.innerHTML = '';
  const keys = Object.keys(RECIPES).filter(k => !categoryKey || RECIPES[k].category === categoryKey);
  
  if (keys.length === 0) {
    container.innerHTML = '<div class="small-note">Bu kategoride hen√ºz √ºr√ºn bulunmuyor</div>';
    return;
  }
  
  keys.forEach(k => { 
    const r = RECIPES[k]; 
    const p = document.createElement('div'); 
    p.className = 'card-btn'; 
    p.innerHTML = `<div class="emoji">${r.emoji}</div><div class="name">${k}</div>`; 
    p.addEventListener('click', () => { 
      openCalcFor(k); 
      setActiveTab('calc'); 
    }); 
    container.appendChild(p); 
  });
}

function getAvailablePriceUnits(originalUnit){
  if(originalUnit === 'gr' || originalUnit === 'kg') return ['kg','gr'];
  if(originalUnit === 'ml' || originalUnit === 'lt') return ['lt','ml'];
  if(originalUnit === 'adet') return ['adet','koli'];
  return [originalUnit,'koli'];
}

/* Calculation UI */
function openCalcFor(name){
  currentProduct = name;
  document.getElementById('calcTitle').textContent = name;
  document.getElementById('calcSubtitle').textContent = RECIPES[name] && RECIPES[name].category ? RECIPES[name].category : '';
  calcItems = (RECIPES[name] && RECIPES[name].ingredients) ? RECIPES[name].ingredients.map(ing => ({ 
    name: ing.name, 
    emoji: ing.emoji || '', 
    qty: ing.qty || ing.quantity || 0, 
    unit: ing.unit || 'gr', 
    price: 0, 
    priceUnit: 'kg', 
    koliSize: 0, 
    calculated: 0 
  })) : [];
  renderCalcItems();
}

function renderCalcItems(){
  const container = document.getElementById('materialsList'); 
  container.innerHTML = '';
  
  if(!calcItems || !calcItems.length){ 
    container.innerHTML = '<div class="small-note">√úr√ºn se√ßin veya malzeme ekleyin</div>'; 
    document.getElementById('totalRow').style.display = 'none'; 
    return; 
  }
  
  calcItems.forEach((it, idx) => {
    const el = document.createElement('div'); 
    el.className = 'material-item';
    const priceUnitOptions = `
      <option value="kg" ${it.priceUnit === 'kg' ? 'selected' : ''}>‚Ç∫ / kg</option>
      <option value="gr" ${it.priceUnit === 'gr' ? 'selected' : ''}>‚Ç∫ / gr</option>
      <option value="lt" ${it.priceUnit === 'lt' ? 'selected' : ''}>‚Ç∫ / lt</option>
      <option value="ml" ${it.priceUnit === 'ml' ? 'selected' : ''}>‚Ç∫ / ml</option>
      <option value="adet" ${it.priceUnit === 'adet' ? 'selected' : ''}>‚Ç∫ / adet</option>
      <option value="koli" ${it.priceUnit === 'koli' ? 'selected' : ''}>‚Ç∫ / koli</option>
    `;
    
    el.innerHTML = `
      <div class="material-top">
        <div class="material-emoji">${it.emoji || 'üßæ'}</div>
        <div class="material-name">${it.name} <span style="color:var(--muted);font-weight:600"> ${it.qty} (${it.unit})</span></div>
      </div>

      <div class="row-controls">
        <div class="left-controls">
          <input type="number" id="qty_${idx}" class="input-small" value="${it.qty}" style="width:80px" title="Miktar" />
          <select id="unit_${idx}" class="unit-select" title="Birim">
            <option value="gr" ${it.unit === 'gr' ? 'selected' : ''}>gr</option>
            <option value="kg" ${it.unit === 'kg' ? 'selected' : ''}>kg</option>
            <option value="ml" ${it.unit === 'ml' ? 'selected' : ''}>ml</option>
            <option value="lt" ${it.unit === 'lt' ? 'selected' : ''}>lt</option>
            <option value="adet" ${it.unit === 'adet' ? 'selected' : ''}>adet</option>
            <option value="dilim" ${it.unit === 'dilim' ? 'selected' : ''}>dilim</option>
          </select>
        </div>

        <div class="right-controls">
          <select id="priceUnit_${idx}" class="unit-select" title="Fiyat birimi">${priceUnitOptions}</select>
          <input type="number" id="price_${idx}" class="input-small" placeholder="Fiyat (TL)" style="width:100px" title="Fiyat gir (√∂rn: kg fiyatƒ± girilecek)" />
          <div class="cost-amount" id="cost_${idx}">${(it.calculated || 0).toFixed(2)} ‚Ç∫</div>
        </div>
      </div>
    `;
    
    container.appendChild(el);

    // events - IDs preserved
    document.getElementById(`qty_${idx}`).addEventListener('input', e => { 
      it.qty = parseFloat(e.target.value || 0); 
      calculateRow(idx); 
    });
    
    document.getElementById(`unit_${idx}`).addEventListener('change', e => { 
      it.unit = e.target.value; 
      renderCalcItems(); 
    });
    
    document.getElementById(`price_${idx}`).addEventListener('input', e => { 
      it.price = parseFloat(e.target.value || 0); 
      calculateRow(idx); 
    });
    
    document.getElementById(`priceUnit_${idx}`).addEventListener('change', e => { 
      it.priceUnit = e.target.value; 
      calculateRow(idx); 
    });

    const rem = document.createElement('button'); 
    rem.className = 'btn-ghost'; 
    rem.textContent = 'Kaldƒ±r'; 
    rem.style.marginLeft = '6px';
    rem.addEventListener('click', () => { 
      calcItems.splice(idx, 1); 
      renderCalcItems(); 
    });
    
    el.querySelector('.material-top').appendChild(rem);
  });
  
  document.getElementById('totalRow').style.display = 'flex';
  calculateTotal();
}

/* calculation */
function calculateRow(idx){
  const it = calcItems[idx]; 
  if(!it) return;
  
  const qty = parseFloat(it.qty || 0); 
  const price = parseFloat(it.price || 0);
  let cost = 0;
  
  if(it.priceUnit === 'koli'){ 
    const ks = parseFloat(it.koliSize || 0); 
    if(ks > 0 && price > 0) cost = (price / ks) * qty; 
    else cost = 0; 
  } else {
    if(it.priceUnit === 'kg' && it.unit === 'gr'){ 
      cost = (price / 1000) * qty; 
    } else if(it.priceUnit === 'lt' && it.unit === 'ml'){ 
      cost = (price / 1000) * qty; 
    } else { 
      cost = price * qty; 
    }
  }
  
  it.calculated = Math.round(cost * 100) / 100;
  const el = document.getElementById('cost_' + idx); 
  if(el) el.textContent = (it.calculated || 0).toFixed(2) + ' ‚Ç∫';
}

function calculateTotal(){ 
  let t = 0; 
  calcItems.forEach((_, i) => { 
    calculateRow(i); 
    t += parseFloat(calcItems[i].calculated || 0); 
  }); 
  
  document.getElementById('totalCost').textContent = t.toFixed(2) + ' ‚Ç∫'; 
  return t; 
}

/* save, preview, saved list (kept unchanged) */
function saveSnapshot(){ 
  const name = (document.getElementById('calcName').value || currentProduct || 'ƒ∞simsiz √úr√ºn').trim(); 
  const total = calculateTotal(); 
  const snap = { 
    name, 
    total, 
    date: new Date().toLocaleString(), 
    items: JSON.parse(JSON.stringify(calcItems)), 
    emoji: (currentProduct && RECIPES[currentProduct] && RECIPES[currentProduct].emoji) ? RECIPES[currentProduct].emoji : '' 
  }; 
  
  savedListArr.unshift(snap); 
  localStorage.setItem('maliq_saved', JSON.stringify(savedListArr)); 
  alert('Kaydedildi.'); 
  renderSaved(); 
}

function renderSaved(){ 
  const savedListEl = document.getElementById('savedList'); 
  savedListEl.innerHTML = ''; 
  
  if(!savedListArr || savedListArr.length === 0){ 
    savedListEl.innerHTML = '<div class="small-note">Hen√ºz kayƒ±tlƒ± maliyet yok</div>'; 
    return; 
  } 
  
  savedListArr.forEach((s, i) => { 
    const el = document.createElement('div'); 
    el.className = 'saved-item'; 
    el.innerHTML = `
      <div style="display:flex;justify-content:space-between;align-items:center;font-weight:700">
        <div>${s.emoji ? s.emoji + ' ' : ''}${s.name}</div>
        <div style="color:var(--accent1)">${s.total.toFixed(2)} ‚Ç∫</div>
      </div>
      <div class="small-note">${s.date}</div>
    `;
    
    const actions = document.createElement('div'); 
    actions.className = 'saved-actions'; 
    
    const bEdit = document.createElement('button'); 
    bEdit.className = 'btn-primary'; 
    bEdit.textContent = 'D√ºzenle'; 
    bEdit.addEventListener('click', () => { 
      calcItems = JSON.parse(JSON.stringify(s.items)); 
      renderCalcItems(); 
      setActiveTab('calc'); 
    }); 
    
    const bDel = document.createElement('button'); 
    bDel.className = 'btn-ghost'; 
    bDel.textContent = 'Sil'; 
    bDel.addEventListener('click', () => { 
      if(confirm('Silinsin mi?')){ 
        savedListArr.splice(i, 1); 
        localStorage.setItem('maliq_saved', JSON.stringify(savedListArr)); 
        renderSaved(); 
      } 
    }); 
    
    const bPdf = document.createElement('button'); 
    bPdf.className = 'btn-ghost'; 
    bPdf.textContent = 'PDF'; 
    bPdf.addEventListener('click', () => previewSavedPdf(i)); 
    
    actions.appendChild(bEdit); 
    actions.appendChild(bDel); 
    actions.appendChild(bPdf); 
    el.appendChild(actions); 
    savedListEl.appendChild(el); 
  }); 
}

/* preview */
let lastPreviewDataUrl = null;

async function generatePreviewElement(title, items, total){
  const container = document.createElement('div'); 
  container.style.padding = '10px'; 
  container.style.background = '#fff'; 
  container.style.color = '#000'; 
  container.style.width = '800px';
  
  container.innerHTML = `
    <h2 style="margin:0">${title} ‚Äî Maliyet</h2>
    <div style="color:#333;margin-top:6px">${new Date().toLocaleString()}</div>
    <table style="width:100%;border-collapse:collapse;margin-top:8px">
      <thead>
        <tr>
          <th style="text-align:left;padding:6px;border-bottom:1px solid #ddd">Malzeme</th>
          <th style="text-align:right;padding:6px;border-bottom:1px solid #ddd">Miktar</th>
          <th style="text-align:right;padding:6px;border-bottom:1px solid #ddd">Maliyet</th>
        </tr>
      </thead>
      <tbody>
        ${items.map(it => `
          <tr>
            <td style="padding:6px;border-bottom:1px solid #eee">${it.emoji || ''} ${it.name}</td>
            <td style="padding:6px;text-align:right;border-bottom:1px solid #eee">${it.qty} ${it.unit}</td>
            <td style="padding:6px;text-align:right;border-bottom:1px solid #eee">${(it.calculated || 0).toFixed(2)} ‚Ç∫</td>
          </tr>
        `).join('')}
      </tbody>
    </table>
    <div style="margin-top:12px;font-weight:700">Toplam: ${total.toFixed(2)} ‚Ç∫</div>
  `;
  
  document.body.appendChild(container);
  
  try{ 
    const canvas = await html2canvas(container, {scale:2, useCORS:true, allowTaint:true}); 
    const dataUrl = canvas.toDataURL('image/png'); 
    return { dataUrl, canvas }; 
  } finally { 
    container.remove(); 
  }
}

async function showPreviewForCurrent(){ 
  if(!calcItems || calcItems.length === 0){ 
    alert('√ñnce hesaplama yapƒ±n'); 
    return; 
  } 
  
  const name = (document.getElementById('calcName').value || currentProduct || 'ƒ∞simsiz').trim(); 
  const total = calculateTotal(); 
  document.getElementById('previewTitle').textContent = name + ' ‚Äî √ñnizleme'; 
  document.getElementById('previewCanvas').innerHTML = '<div style="color:#666">√ñnizleme hazƒ±rlanƒ±yor...</div>'; 
  document.getElementById('previewModal').style.display = 'flex'; 
  
  try{ 
    const { dataUrl } = await generatePreviewElement(name, calcItems, total); 
    lastPreviewDataUrl = dataUrl; 
    document.getElementById('previewCanvas').innerHTML = `<img src="${dataUrl}" alt="preview">`; 
  } catch(err){ 
    document.getElementById('previewCanvas').innerHTML = '<div style="color:#c00">√ñnizleme olu≈üturulamadƒ±.</div>'; 
    console.error(err); 
  } 
}

async function previewSavedPdf(i){ 
  const snap = savedListArr[i]; 
  if(!snap) return; 
  
  document.getElementById('previewTitle').textContent = snap.name + ' ‚Äî √ñnizleme'; 
  document.getElementById('previewCanvas').innerHTML = '<div style="color:#666">√ñnizleme hazƒ±rlanƒ±yor...</div>'; 
  document.getElementById('previewModal').style.display = 'flex'; 
  
  try{ 
    const { dataUrl } = await generatePreviewElement(snap.name, snap.items, snap.total); 
    lastPreviewDataUrl = dataUrl; 
    document.getElementById('previewCanvas').innerHTML = `<img src="${dataUrl}" alt="preview">`; 
  } catch(err){ 
    document.getElementById('previewCanvas').innerHTML = '<div style="color:#c00">√ñnizleme olu≈üturulamadƒ±.</div>'; 
    console.error(err); 
  } 
}

document.getElementById('downloadPreviewBtn').addEventListener('click', async () => { 
  if(!lastPreviewDataUrl){ 
    alert('√ñnizleme hazƒ±rlanmadƒ±'); 
    return; 
  } 
  
  try{ 
    const { jsPDF } = window.jspdf; 
    const pdf = new jsPDF({ unit:'pt', format:'a4' }); 
    const imgProps = pdf.getImageProperties(lastPreviewDataUrl); 
    const pageWidth = pdf.internal.pageSize.getWidth() - 40; 
    const height = imgProps.height * pageWidth / imgProps.width; 
    pdf.addImage(lastPreviewDataUrl, 'PNG', 20, 20, pageWidth, height); 
    const filename = (document.getElementById('previewTitle').textContent || 'maliyet').replace(/\s+/g,'_') + '.pdf'; 
    pdf.save(filename); 
  } catch(err){ 
    alert('PDF indirilemedi. Konsolu kontrol edin.'); 
    console.error(err); 
  } finally { 
    document.getElementById('previewModal').style.display = 'none'; 
    lastPreviewDataUrl = null; 
  } 
});

document.getElementById('closePreviewBtn').addEventListener('click', () => { 
  document.getElementById('previewModal').style.display = 'none'; 
  lastPreviewDataUrl = null; 
});

/* Developer Mode Functions */
function updateVisitorStats() {
  visitorStats.totalVisits++;
  
  // Check if this is a unique visitor (simple approach using localStorage)
  let uniqueVisitors = JSON.parse(localStorage.getItem('maliq_unique_visitors') || '[]');
  const visitorId = localStorage.getItem('maliq_visitor_id');
  
  if (!visitorId) {
    // New visitor
    const newId = 'visitor_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    localStorage.setItem('maliq_visitor_id', newId);
    uniqueVisitors.push(newId);
    visitorStats.uniqueVisitors = uniqueVisitors.length;
    localStorage.setItem('maliq_unique_visitors', JSON.stringify(uniqueVisitors));
  }
  
  visitorStats.lastVisit = new Date().toISOString();
  localStorage.setItem('maliq_stats', JSON.stringify(visitorStats));
}

function updateDevStats() {
  document.getElementById('totalVisits').textContent = visitorStats.totalVisits;
  document.getElementById('uniqueVisitors').textContent = visitorStats.uniqueVisitors;
  document.getElementById('devLogins').textContent = visitorStats.devLogins;
  document.getElementById('savedCalculations').textContent = savedListArr.length;
  
  // Update category select dropdowns
  updateCategorySelects();
}

function updateCategorySelects() {
  const parentSelect = document.getElementById('parentCategorySelect');
  const productSelect = document.getElementById('productCategorySelect');
  const quickAddSelect = document.getElementById('quickAddCategorySelect');
  
  // Clear existing options except the first one
  while (parentSelect.children.length > 1) {
    parentSelect.removeChild(parentSelect.lastChild);
  }
  while (productSelect.children.length > 1) {
    productSelect.removeChild(productSelect.lastChild);
  }
  while (quickAddSelect.children.length > 1) {
    quickAddSelect.removeChild(quickAddSelect.lastChild);
  }
  
  // Add categories to selects
  CATEGORIES.forEach(cat => {
    const option1 = document.createElement('option');
    option1.value = cat.id;
    option1.textContent = cat.name;
    parentSelect.appendChild(option1);
    
    const option2 = document.createElement('option');
    option2.value = cat.id;
    option2.textContent = cat.name;
    productSelect.appendChild(option2);
    
    const option3 = document.createElement('option');
    option3.value = cat.id;
    option3.textContent = cat.name;
    quickAddSelect.appendChild(option3);
  });
}

function addCategory() {
  const name = document.getElementById('newCategoryName').value.trim();
  const emoji = document.getElementById('newCategoryEmoji').value.trim() || 'üìÅ';
  const parentId = document.getElementById('parentCategorySelect').value || null;
  
  if (!name) {
    alert('Kategori adƒ± gerekli!');
    return;
  }
  
  const newCategory = {
    id: 'cat_' + Date.now(),
    name: name,
    emoji: emoji,
    parentId: parentId
  };
  
  CATEGORIES.push(newCategory);
  localStorage.setItem('maliq_categories', JSON.stringify(CATEGORIES));
  
  // Clear inputs
  document.getElementById('newCategoryName').value = '';
  document.getElementById('newCategoryEmoji').value = '';
  
  // Update UI
  renderCategories();
  updateCategorySelects();
  
  alert('Kategori eklendi!');
}

function addProduct() {
  const name = document.getElementById('newProductName').value.trim();
  const emoji = document.getElementById('newProductEmoji').value.trim() || 'üçΩÔ∏è';
  const category = document.getElementById('productCategorySelect').value;
  
  if (!name || !category) {
    alert('√úr√ºn adƒ± ve kategori se√ßimi gerekli!');
    return;
  }
  
  // Add to RECIPES
  RECIPES[name] = {
    category: category,
    emoji: emoji,
    ingredients: []
  };
  
  // Update product names for search animation
  updateProductNames();
  
  // Clear inputs
  document.getElementById('newProductName').value = '';
  document.getElementById('newProductEmoji').value = '';
  
  // Update UI
  renderProducts(null);
  
  alert('√úr√ºn eklendi!');
}

function quickAddProducts() {
  const text = document.getElementById('quickProductsText').value.trim();
  const selectedCategory = document.getElementById('quickAddCategorySelect').value;
  
  if (!text) {
    alert('L√ºtfen √ºr√ºn verilerini girin!');
    return;
  }
  
  const lines = text.split('\n');
  let currentCategory = selectedCategory || null;
  let currentProduct = null;
  let addedCategories = 0;
  let addedProducts = 0;
  let addedIngredients = 0;
  
  lines.forEach(line => {
    line = line.trim();
    if (!line) return;
    
    if (line.startsWith('+')) {
      // Category line
      const emojiAndName = line.substring(1).trim();
      const emojiMatch = emojiAndName.match(/^(\p{Emoji})?\s*(.+)$/u);
      if (emojiMatch) {
        const emoji = emojiMatch[1] || 'üìÅ';
        const name = emojiMatch[2].trim();
        
        const newCategory = {
          id: 'cat_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
          name: name,
          emoji: emoji,
          parentId: selectedCategory || null
        };
        
        CATEGORIES.push(newCategory);
        currentCategory = newCategory.id;
        addedCategories++;
      }
    } else if (line.startsWith('-')) {
      // Product line
      const emojiAndName = line.substring(1).trim();
      const emojiMatch = emojiAndName.match(/^(\p{Emoji})?\s*(.+)$/u);
      if (emojiMatch) {
        const emoji = emojiMatch[1] || 'üçΩÔ∏è';
        const name = emojiMatch[2].trim();
        
        if (!currentCategory) {
          alert('L√ºtfen √∂nce bir kategori ekleyin veya mevcut bir kategori se√ßin!');
          return;
        }
        
        currentProduct = {
          name: name,
          emoji: emoji,
          category: currentCategory,
          ingredients: []
        };
        
        RECIPES[name] = {
          category: currentCategory,
          emoji: emoji,
          ingredients: []
        };
        
        addedProducts++;
      }
    } else if (line && currentProduct) {
      // Ingredient line
      const ingredientMatch = line.match(/^(\p{Emoji})?\s*([^:]+):\s*(\d+(\.\d+)?)\s*(\S+)$/u);
      if (ingredientMatch) {
        const emoji = ingredientMatch[1] || '';
        const name = ingredientMatch[2].trim();
        const qty = parseFloat(ingredientMatch[3]);
        const unit = ingredientMatch[5].trim();
        
        if (RECIPES[currentProduct.name]) {
          RECIPES[currentProduct.name].ingredients.push({
            name: name,
            emoji: emoji,
            qty: qty,
            unit: unit
          });
          addedIngredients++;
        }
      }
    }
  });
  
  // Update product names for search animation
  updateProductNames();
  
  // Save categories to localStorage
  localStorage.setItem('maliq_categories', JSON.stringify(CATEGORIES));
  
  // Clear textarea
  document.getElementById('quickProductsText').value = '';
  
  // Close modal
  document.getElementById('quickAddModal').style.display = 'none';
  
  // Update UI
  renderCategories();
  renderProducts(null);
  updateCategorySelects();
  
  alert(`${addedCategories} kategori, ${addedProducts} √ºr√ºn ve ${addedIngredients} malzeme eklendi!`);
}

function exportAllData() {
  const data = {
    categories: CATEGORIES,
    recipes: RECIPES,
    saved: savedListArr,
    stats: visitorStats
  };
  
  const dataStr = JSON.stringify(data, null, 2);
  const dataBlob = new Blob([dataStr], {type: 'application/json'});
  
  const url = URL.createObjectURL(dataBlob);
  const link = document.createElement('a');
  link.href = url;
  link.download = 'maliq_data_' + new Date().toISOString().split('T')[0] + '.json';
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
}

function importAllData() {
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = '.json';
  
  input.onchange = e => {
    const file = e.target.files[0];
    const reader = new FileReader();
    
    reader.onload = function(event) {
      try {
        const data = JSON.parse(event.target.result);
        
        if (data.categories) {
          CATEGORIES = data.categories;
          localStorage.setItem('maliq_categories', JSON.stringify(CATEGORIES));
        }
        
        if (data.recipes) {
          Object.keys(data.recipes).forEach(key => {
            RECIPES[key] = data.recipes[key];
          });
        }
        
        if (data.saved) {
          savedListArr = data.saved;
          localStorage.setItem('maliq_saved', JSON.stringify(savedListArr));
        }
        
        if (data.stats) {
          visitorStats = data.stats;
          localStorage.setItem('maliq_stats', JSON.stringify(visitorStats));
        }
        
        // Update UI
        updateProductNames();
        renderCategories();
        renderProducts(null);
        renderSaved();
        updateDevStats();
        
        alert('Veriler ba≈üarƒ±yla i√ße aktarƒ±ldƒ±!');
      } catch (err) {
        alert('Dosya okunamadƒ±: ' + err.message);
      }
    };
    
    reader.readAsText(file);
  };
  
  input.click();
}

function resetData() {
  if (confirm('T√úM veriler sƒ±fƒ±rlanacak. Emin misiniz?')) {
    localStorage.clear();
    location.reload();
  }
}

// wiring tabs and init
document.getElementById('tabCategories').addEventListener('click', () => setActiveTab('categories'));
document.getElementById('tabProducts').addEventListener('click', () => setActiveTab('products'));
document.getElementById('tabCalc').addEventListener('click', () => setActiveTab('calc'));
document.getElementById('tabSaved').addEventListener('click', () => { setActiveTab('saved'); renderSaved(); });
document.getElementById('tabDev').addEventListener('click', () => { setActiveTab('dev'); updateDevStats(); });

document.getElementById('addMaterialBtn').addEventListener('click', () => { 
  document.getElementById('addModal').style.display = 'flex'; 
  document.getElementById('addModal').setAttribute('aria-hidden', 'false'); 
});

document.getElementById('closeAddModal').addEventListener('click', () => { 
  document.getElementById('addModal').style.display = 'none'; 
  document.getElementById('addModal').setAttribute('aria-hidden', 'true'); 
});

document.getElementById('confirmAdd').addEventListener('click', () => {
  const name = document.getElementById('addName').value.trim() || 'Yeni Malzeme';
  const qty = parseFloat(document.getElementById('addQty').value || 0);
  const unit = document.getElementById('addUnit').value;
  const price = parseFloat(document.getElementById('addPrice').value || 0);
  const priceUnit = document.getElementById('addPriceUnit').value;
  const koliSize = parseFloat(document.getElementById('addKoliSize').value || 0);
  calcItems.push({ name, emoji: '', qty, unit, price, priceUnit, koliSize, calculated: 0 });
  document.getElementById('addModal').style.display = 'none';
  renderCalcItems();
});

document.getElementById('addPriceUnit').addEventListener('change', e => { 
  document.getElementById('addKoliRow').style.display = e.target.value === 'koli' ? 'block' : 'none'; 
});

document.getElementById('saveBtn').addEventListener('click', () => saveSnapshot());
document.getElementById('clearBtn').addEventListener('click', () => { 
  if(confirm('Hesaplamayƒ± temizlemek istiyor musunuz?')){ 
    calcItems = []; 
    renderCalcItems(); 
  } 
});

document.getElementById('exportBtn').addEventListener('click', () => showPreviewForCurrent());

// Developer mode event listeners
document.getElementById('addCategoryBtn').addEventListener('click', addCategory);
document.getElementById('addProductBtn').addEventListener('click', addProduct);

document.getElementById('quickAddProductsBtn').addEventListener('click', () => {
  document.getElementById('quickAddModal').style.display = 'flex';
});

document.getElementById('closeQuickAddModal').addEventListener('click', () => {
  document.getElementById('quickAddModal').style.display = 'none';
});

document.getElementById('confirmQuickAdd').addEventListener('click', quickAddProducts);

document.getElementById('cancelQuickAdd').addEventListener('click', () => {
  document.getElementById('quickAddModal').style.display = 'none';
});

document.getElementById('exportAllDataBtn').addEventListener('click', exportAllData);
document.getElementById('importAllDataBtn').addEventListener('click', importAllData);
document.getElementById('resetDataBtn').addEventListener('click', resetData);

// Initialize
updateVisitorStats();
updateProductNames();
renderCategories();
renderProducts(null);
setActiveTab('categories');
renderSaved();
updateDevStats();
</script>
</body>
</html>
