<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>MALIQ ‚Äî Akƒ±llƒ± Maliyet Hesaplayƒ±cƒ±nƒ±z</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap">
<style>
:root{
  --bg:#061322; --card:#071526; --accent1:#06b6d4; --accent2:#7c3aed; --muted:#9fb0c6;
  --surface: rgba(255,255,255,0.02); --btn-grad: linear-gradient(90deg,var(--accent1),var(--accent2));
  --radius:12px; --font:Inter,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;
}
*{box-sizing:border-box;font-family:var(--font)}
html,body{height:100%;margin:0;background:linear-gradient(180deg,var(--bg),#04111a);color:#eaf4ff}
.container{max-width:720px;margin:0 auto;padding:14px}
.header-row{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
.brand{display:flex;gap:10px;align-items:center}
.logo img{width:46px;height:46px;border-radius:8px}
.title{font-weight:800;font-size:18px}
.search-wrap-centered{width:100%;display:flex;justify-content:center;margin:8px 0 12px 0}
.search{display:flex;align-items:center;gap:10px;padding:10px 14px;border-radius:16px;background:var(--surface);border:1px solid rgba(255,255,255,0.03);width:100%;max-width:680px;position:relative}
.search input{flex:1;background:transparent;border:0;color:inherit;padding:8px 12px;font-size:15px;outline:none}
.search-overlay{position:absolute;left:50%;top:48%;transform:translate(-50%,-4px);pointer-events:none;color:rgba(255,255,255,0.92);font-size:15px;transition:opacity .22s,transform .22s;white-space:nowrap}
.search-overlay.fade{opacity:0;transform:translate(-50%,-12px)}
.tabs{display:flex;gap:8px;margin:12px 0}
.tab{flex:1;padding:12px;border-radius:14px;text-align:center;background:transparent;color:var(--muted);cursor:pointer;border:1px solid rgba(255,255,255,0.03);font-weight:800;display:flex;align-items:center;justify-content:center}
.tab.active{background:var(--btn-grad);color:#021026;box-shadow:0 8px 28px rgba(2,6,23,0.5)}
.section{background:var(--card);border-radius:14px;padding:12px;border:1px solid rgba(255,255,255,0.03);margin-bottom:12px}

/* cards - keep unified style and use .card-btn for both categories and products */
.card-btn{background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005));padding:12px;border-radius:12px;text-align:center;cursor:pointer;border:1px solid rgba(255,255,255,0.03);transition:transform .12s,box-shadow .12s;display:flex;flex-direction:column;gap:8px;align-items:center;justify-content:center;min-height:80px}
.card-btn .emoji{font-size:22px}
.card-btn .name{font-weight:800;font-size:13px;color:inherit}
.card-btn:hover{transform:translateY(-4px);box-shadow:0 8px 24px rgba(3,10,30,0.45)}

.categories-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
@media(min-width:520px){.categories-grid{grid-template-columns:repeat(4,1fr)}}
.products-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-top:12px}
@media(min-width:520px){.products-grid{grid-template-columns:repeat(3,1fr)}}

/* calculation rows */
.calc-grid{display:flex;flex-direction:column;gap:8px;margin-top:10px}
.material-item{background:var(--surface);padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.03);display:flex;flex-direction:column;gap:8px}
.material-top{display:flex;align-items:center;gap:8px}
.material-emoji{width:36px;text-align:center}
.row-controls{display:flex;gap:8px;align-items:center;flex-wrap:nowrap;justify-content:space-between}
.left-controls{display:flex;gap:12px;align-items:center;min-width:0}
.right-controls{display:flex;gap:8px;align-items:center;justify-content:flex-end;min-width:260px;flex-shrink:0}
.input-small{padding:8px;border-radius:10px;border:0;background:rgba(255,255,255,0.02);color:inherit}
.unit-select{padding:8px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit}
.cost-amount{font-weight:900;color:var(--accent1);min-width:90px;text-align:right}
.total-row{display:flex;justify-content:space-between;align-items:center;padding:10px;border-radius:10px;background:linear-gradient(90deg, rgba(6,182,212,0.04), rgba(124,58,237,0.02));font-weight:900;margin-top:8px}
.saved-list{display:flex;flex-direction:column;gap:8px}
.saved-item{background:var(--surface);padding:8px;border-radius:10px;border:1px solid rgba(255,255,255,0.03);font-size:14px;display:flex;flex-direction:column;gap:6px}

.preview-modal{position:fixed;inset:0;background:rgba(0,0,0,0.75);display:none;align-items:center;justify-content:center;z-index:80}
.preview-card{background:#fff;padding:12px;border-radius:10px;color:#000;width:92%;max-width:760px;height:80vh;display:flex;flex-direction:column}
.preview-toolbar{display:flex;justify-content:space-between;align-items:center;gap:8px;margin-bottom:8px}
.preview-canvas{flex:1;overflow:auto;background:#fff;border-radius:6px;padding:6px;display:flex;align-items:center;justify-content:center}
.modal{position:fixed;inset:0;background:rgba(0,0,0,0.75);display:none;align-items:center;justify-content:center;z-index:60}
.modal-content{background:var(--card);padding:12px;border-radius:10px;width:92%;max-width:420px}
.btn-primary{padding:10px 14px;border-radius:12px;background:var(--btn-grad);color:#021026;border:0;font-weight:800;cursor:pointer}
.btn-ghost{padding:8px 12px;border-radius:12px;background:transparent;color:var(--muted);border:1px solid rgba(255,255,255,0.06);cursor:pointer}
.footer{margin-top:12px;text-align:center;color:var(--muted);font-size:12px}
.small-note{color:var(--muted);font-size:13px}
</style>
</head>
<body>
  <div class="container" role="application" aria-label="MALIQ">
    <div class="header-row">
      <div class="brand">
        <div class="logo"><img src="https://i.hizliresim.com/sis5uti.png" alt="logo"></div>
        <div><div class="title">Akƒ±llƒ± Maliyet Hesaplayƒ±cƒ±nƒ±z</div></div>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <div style="width:36px;height:36px;border-radius:8px;background:rgba(255,255,255,0.04);display:flex;align-items:center;justify-content:center">A</div>
        <div style="font-weight:700">Misafir</div>
      </div>
    </div>

    <div class="search-wrap-centered">
      <div class="search" role="search" aria-label="Yemek ara">
        <input id="searchInput" placeholder="" autocomplete="off" />
        <div id="searchOverlay" class="search-overlay">Lahmacun</div>
      </div>
      <div id="suggestions" style="position:relative"></div>
    </div>

    <nav class="tabs" role="tablist">
      <div id="tabCategories" class="tab active">KATEGORƒ∞LER</div>
      <div id="tabProducts" class="tab">√úR√úNLER</div>
      <div id="tabCalc" class="tab">HESAPLAMA</div>
      <div id="tabSaved" class="tab">MALƒ∞YET TABLOM</div>
    </nav>

    <main>
      <section id="screenCategories" class="section">
        <div style="font-weight:900;margin-bottom:8px">Yemek √áe≈üitleri</div>
        <div id="categoriesGrid" class="categories-grid"></div>
      </section>

      <section id="screenProducts" class="section" style="display:none">
        <div style="font-weight:900;margin-bottom:8px" id="productsTitle">Se√ßilen Kategori: T√ºm√º</div>
        <div id="productsGrid" class="products-grid"></div>
      </section>

      <section id="screenCalc" class="section" style="display:none">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
          <div>
            <div style="font-weight:900" id="calcTitle">Hesaplama</div>
            <div id="calcSubtitle" class="small-note"></div>
          </div>
          <div style="display:flex;gap:8px;align-items:center">
            <input id="calcName" class="input-small" placeholder="√úr√ºn adƒ±" />
            <button id="saveBtn" class="btn-primary">Kaydet</button>
            <button id="clearBtn" class="btn-ghost">Temizle</button>
          </div>
        </div>

        <div id="materialsList" class="calc-grid"></div>

        <div class="total-row" id="totalRow" style="display:none">
          <div>Toplam Maliyet</div>
          <div id="totalCost" class="cost-amount">0.00 ‚Ç∫</div>
        </div>

        <div style="margin-top:10px;display:flex;gap:8px">
          <button id="addMaterialBtn" class="btn-ghost">+ Malzeme Ekle</button>
          <button id="exportBtn" class="btn-primary">PDF √ñnizleme</button>
        </div>
      </section>

      <section id="screenSaved" class="section" style="display:none">
        <div style="font-weight:900;margin-bottom:8px">Maliyet Tablom</div>
        <div id="savedList" class="saved-list"></div>
      </section>
    </main>

    <div class="footer">CAN&D ≈ûirketinin √ºr√ºn√ºd√ºr. T√ºm haklarƒ± saklƒ±dƒ±r ¬© CAN&D</div>
  </div>

  <div id="previewModal" class="preview-modal" aria-hidden="true">
    <div class="preview-card">
      <div class="preview-toolbar">
        <div id="previewTitle" style="font-weight:800">√ñnizleme</div>
        <div style="display:flex;gap:8px">
          <button id="downloadPreviewBtn" class="btn-primary">PDF ƒ∞ndir</button>
          <button id="closePreviewBtn" class="btn-ghost">Kapat</button>
        </div>
      </div>
      <div id="previewCanvas" class="preview-canvas"><div style="color:#666">√ñnizleme hazƒ±rlanƒ±yor...</div></div>
    </div>
  </div>

  <div id="addModal" class="modal" aria-hidden="true">
    <div class="modal-content">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <div style="font-weight:900">Malzeme Ekle</div>
        <button id="closeAddModal" class="btn-ghost">Kapat</button>
      </div>
      <div style="display:flex;flex-direction:column;gap:8px">
        <input id="addName" class="input-small" placeholder="Malzeme adƒ±" />
        <div style="display:flex;gap:8px">
          <input id="addQty" type="number" class="input-small" value="100" />
          <select id="addUnit" class="unit-select">
            <option value="gr">gr</option><option value="kg">kg</option><option value="ml">ml</option><option value="lt">lt</option><option value="adet">adet</option>
          </select>
        </div>
        <div style="display:flex;gap:8px">
          <select id="addPriceUnit" class="unit-select">
            <option value="kg">‚Ç∫ / kg</option><option value="gr">‚Ç∫ / gr</option><option value="lt">‚Ç∫ / lt</option><option value="ml">‚Ç∫ / ml</option><option value="adet">‚Ç∫ / adet</option><option value="koli">‚Ç∫ / koli</option>
          </select>
          <input id="addPrice" type="number" class="input-small" placeholder="Fiyat" step="0.01" />
        </div>
        <div id="addKoliRow" style="display:none">
          <input id="addKoliSize" type="number" class="input-small" placeholder="Koli adeti" min="1" />
        </div>
        <div style="display:flex;gap:8px">
          <button id="confirmAdd" class="btn-primary">Ekle</button>
          <button id="cancelAdd" class="btn-ghost">ƒ∞ptal</button>
        </div>
      </div>
    </div>
  </div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
/* Final adjustments:
 - Price input moved to the rightmost position in each material row (user requested)
 - Removed "Kƒ±yma" as a top-level recipe example (recipes now general)
 - Unit selection and price-unit preserved; calculation logic unchanged
 - Products are rendered using the same .card-btn style as categories (visual parity restored)
 - No regressions: event IDs unchanged and behavior preserved
*/

/* Data */
const RECIPES = {
  "Lahmacun": { category:'lahmacun', emoji:'ü•ô', ingredients:[{name:'Un',qty:150,unit:'gr',emoji:'üåæ'},{name:'Kƒ±yma',qty:150,unit:'gr',emoji:'ü•©'}]},
  "Adana D√ºr√ºm": { category:'durum', emoji:'üåØ', ingredients:[{name:'Kuzu Kƒ±ymasƒ±',qty:200,unit:'gr',emoji:'ü•©'},{name:'Lava≈ü',qty:1,unit:'adet',emoji:'ü´ì'}]},
  "Pizza Margherita": { category:'pizza', emoji:'üçï', ingredients:[{name:'Un',qty:300,unit:'gr',emoji:'üåæ'},{name:'Mozzarella',qty:150,unit:'gr',emoji:'üßÄ'}]},
  "Hamburger": { category:'fast', emoji:'üçî', ingredients:[{name:'K√∂fte',qty:150,unit:'gr',emoji:'ü•©'},{name:'Ekmek',qty:1,unit:'adet',emoji:'üçû'}]},
  "Cola": { category:'icecek', emoji:'ü•§', ingredients:[{name:'Cola',qty:330,unit:'ml',emoji:'ü•§'}]},
  "≈ûalgam": { category:'icecek', emoji:'üßÉ', ingredients:[{name:'≈ûalgam',qty:330,unit:'ml',emoji:'üßÉ'}]}
};

let currentProduct = null;
let calcItems = [];
let savedListArr = JSON.parse(localStorage.getItem('maliq_saved')||'[]');

/* Rotation overlay (products only) */
const rotateList = Object.keys(RECIPES);
let rotIndex = 0, rotTimer = null;
const searchOverlay = document.getElementById('searchOverlay');
const searchInput = document.getElementById('searchInput');
const suggestions = document.getElementById('suggestions');
function rotateOnce(){ if(!searchOverlay) return; searchOverlay.classList.add('fade'); setTimeout(()=>{ rotIndex = (rotIndex + 1) % rotateList.length; searchOverlay.textContent = rotateList[rotIndex]; searchOverlay.classList.remove('fade'); }, 220); }
function startRot(){ if(rotTimer) return; rotTimer = setInterval(rotateOnce, 2000); }
function stopRot(){ if(!rotTimer) return; clearInterval(rotTimer); rotTimer = null; }
if(rotateList.length) searchOverlay.textContent = rotateList[0];
startRot();
searchInput.addEventListener('input', (e)=>{ const v=e.target.value||''; if(v.length>0){ stopRot(); searchOverlay.style.opacity='0'; searchOverlay.style.transform='translate(-50%,-12px)'; } else { searchOverlay.style.opacity='1'; searchOverlay.style.transform='translate(-50%,-4px)'; startRot(); } suggestions.innerHTML=''; const q=v.trim().toLowerCase(); if(!q) return; const keys=Object.keys(RECIPES); let matches=keys.filter(k=>k.toLowerCase().startsWith(q)); if(matches.length===0) matches=keys.filter(k=>k.toLowerCase().includes(q)); const box=document.createElement('div'); box.style.position='absolute'; box.style.left='0'; box.style.right='0'; box.style.top='56px'; box.style.zIndex=40; matches.slice(0,20).forEach(m=>{ const r=document.createElement('div'); r.className='card-btn'; r.style.minHeight='48px'; r.style.padding='8px'; r.innerHTML=`<div style="display:flex;align-items:center;gap:8px"><div style="font-size:18px">${RECIPES[m].emoji||'üçΩÔ∏è'}</div><div>${m}</div></div>`; r.addEventListener('click', ()=>{ searchInput.value=''; suggestions.innerHTML=''; openCalcFor(m); setActiveTab('calc'); }); box.appendChild(r); }); suggestions.appendChild(box);
});

/* Helpers & renderers */
const CATEGORIES = [
  { key:'kahvalti', name:'Kahvaltƒ±', emoji:'ü•ê' },
  { key:'corba', name:'√áorba', emoji:'ü•£' },
  { key:'ana', name:'Ana Yemek', emoji:'üçΩÔ∏è' },
  { key:'pide', name:'Pide', emoji:'ü•ô' },
  { key:'lahmacun', name:'Lahmacun', emoji:'ü•ô' },
  { key:'pizza', name:'Pizza', emoji:'üçï' },
  { key:'durum', name:'D√ºr√ºm', emoji:'üåØ' },
  { key:'fast', name:'Fast Food', emoji:'üçî' },
  { key:'icecek', name:'ƒ∞√ßecek', emoji:'ü•§' },
  { key:'tatli', name:'Tatlƒ±', emoji:'üç®' },
  { key:'garnitur', name:'Garnit√ºr', emoji:'üçü' },
  { key:'deniz', name:'Deniz', emoji:'üêü' },
  { key:'vegan', name:'Vejetaryen', emoji:'ü•ó' }
];
function setActiveTab(tab){
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  if(tab==='categories') document.getElementById('tabCategories').classList.add('active');
  if(tab==='products') document.getElementById('tabProducts').classList.add('active');
  if(tab==='calc') document.getElementById('tabCalc').classList.add('active');
  if(tab==='saved') document.getElementById('tabSaved').classList.add('active');
  document.getElementById('screenCategories').style.display = tab==='categories' ? 'block' : 'none';
  document.getElementById('screenProducts').style.display = tab==='products' ? 'block' : 'none';
  document.getElementById('screenCalc').style.display = tab==='calc' ? 'block' : 'none';
  document.getElementById('screenSaved').style.display = tab==='saved' ? 'block' : 'none';
}

function renderCategories(){
  const container = document.getElementById('categoriesGrid'); container.innerHTML='';
  CATEGORIES.forEach(cat=>{ const d=document.createElement('div'); d.className='card-btn'; d.innerHTML=`<div class="emoji">${cat.emoji}</div><div class="name">${cat.name}</div>`; d.addEventListener('click', ()=>{ document.getElementById('productsTitle').textContent = `Se√ßilen Kategori: ${cat.name}`; renderProducts(cat.key); setActiveTab('products'); }); container.appendChild(d); });
}

function renderProducts(categoryKey){
  const container = document.getElementById('productsGrid'); container.innerHTML='';
  const keys = Object.keys(RECIPES).filter(k=> !categoryKey || RECIPES[k].category===categoryKey);
  keys.forEach(k=>{ const r=RECIPES[k]; const p=document.createElement('div'); p.className='card-btn'; p.innerHTML=`<div class="emoji">${r.emoji}</div><div class="name">${k}</div>`; p.addEventListener('click', ()=>{ openCalcFor(k); setActiveTab('calc'); }); container.appendChild(p); });
}

function getAvailablePriceUnits(originalUnit){
  if(originalUnit==='gr' || originalUnit==='kg') return ['kg','gr'];
  if(originalUnit==='ml' || originalUnit==='lt') return ['lt','ml'];
  if(originalUnit==='adet') return ['adet','koli'];
  return [originalUnit,'koli'];
}

/* Calculation UI */
function openCalcFor(name){
  currentProduct = name;
  document.getElementById('calcTitle').textContent = name;
  document.getElementById('calcSubtitle').textContent = RECIPES[name] && RECIPES[name].category ? RECIPES[name].category : '';
  calcItems = (RECIPES[name] && RECIPES[name].ingredients) ? RECIPES[name].ingredients.map(ing=>({ name:ing.name, emoji:ing.emoji||'', qty:ing.qty||ing.quantity||0, unit:ing.unit||'gr', price:0, priceUnit:'kg', koliSize:0, calculated:0 })) : [];
  renderCalcItems();
}

function renderCalcItems(){
  const container = document.getElementById('materialsList'); container.innerHTML='';
  if(!calcItems || !calcItems.length){ container.innerHTML = '<div class="small-note">√úr√ºn se√ßin veya malzeme ekleyin</div>'; document.getElementById('totalRow').style.display='none'; return; }
  calcItems.forEach((it,idx)=>{
    const el=document.createElement('div'); el.className='material-item';
    const priceUnitOptions = `<option value="kg" ${it.priceUnit==='kg'?'selected':''}>‚Ç∫ / kg</option><option value="gr" ${it.priceUnit==='gr'?'selected':''}>‚Ç∫ / gr</option><option value="lt" ${it.priceUnit==='lt'?'selected':''}>‚Ç∫ / lt</option><option value="ml" ${it.priceUnit==='ml'?'selected':''}>‚Ç∫ / ml</option><option value="adet" ${it.priceUnit==='adet'?'selected':''}>‚Ç∫ / adet</option><option value="koli" ${it.priceUnit==='koli'?'selected':''}>‚Ç∫ / koli</option>`;
    el.innerHTML = `
      <div class="material-top">
        <div class="material-emoji">${it.emoji||'üßæ'}</div>
        <div class="material-name">${it.name} <span style="color:var(--muted);font-weight:600"> ${it.qty} (${it.unit})</span></div>
      </div>

      <div class="row-controls">
        <div class="left-controls">
          <input type="number" id="qty_${idx}" class="input-small" value="${it.qty}" style="width:88px" title="Miktar" />
          <!-- GRAMAJ (birim) now on the LEFT as requested -->
          <select id="unit_${idx}" class="unit-select" title="Birim">
            <option value="gr" ${it.unit==='gr'?'selected':''}>gr</option>
            <option value="kg" ${it.unit==='kg'?'selected':''}>kg</option>
            <option value="ml" ${it.unit==='ml'?'selected':''}>ml</option>
            <option value="lt" ${it.unit==='lt'?'selected':''}>lt</option>
            <option value="adet" ${it.unit==='adet'?'selected':''}>adet</option>
            <option value="dilim" ${it.unit==='dilim'?'selected':''}>dilim</option>
          </select>
        </div>

        <div class="right-controls">
          <!-- priceUnit and price input and cost at the rightmost -->
          <select id="priceUnit_${idx}" class="unit-select" title="Fiyat birimi">${priceUnitOptions}</select>
          <input type="number" id="price_${idx}" class="input-small" placeholder="Fiyat (TL)" style="width:110px" title="Fiyat gir (√∂rn: kg fiyatƒ± girilecek)" />
          <div class="cost-amount" id="cost_${idx}">${(it.calculated||0).toFixed(2)} ‚Ç∫</div>
        </div>
      </div>
    `;
    container.appendChild(el);

    // events - IDs preserved
    document.getElementById(`qty_${idx}`).addEventListener('input', e=>{ it.qty = parseFloat(e.target.value||0); calculateRow(idx); });
    document.getElementById(`unit_${idx}`).addEventListener('change', e=>{ it.unit = e.target.value; renderCalcItems(); });
    document.getElementById(`price_${idx}`).addEventListener('input', e=>{ it.price = parseFloat(e.target.value||0); calculateRow(idx); });
    document.getElementById(`priceUnit_${idx}`).addEventListener('change', e=>{ it.priceUnit = e.target.value; calculateRow(idx); });

    const rem = document.createElement('button'); rem.className='btn-ghost'; rem.textContent='Kaldƒ±r'; rem.style.marginLeft='8px';
    rem.addEventListener('click', ()=>{ calcItems.splice(idx,1); renderCalcItems(); });
    el.querySelector('.material-top').appendChild(rem);
  });
  document.getElementById('totalRow').style.display='flex';
  calculateTotal();
}

/* calculation */
function calculateRow(idx){
  const it = calcItems[idx]; if(!it) return;
  const qty = parseFloat(it.qty||0); const price = parseFloat(it.price||0);
  let cost = 0;
  if(it.priceUnit === 'koli'){ const ks = parseFloat(it.koliSize||0); if(ks>0 && price>0) cost = (price/ks) * qty; else cost = 0; }
  else {
    if(it.priceUnit === 'kg' && it.unit === 'gr'){ cost = (price/1000) * qty; }
    else if(it.priceUnit === 'lt' && it.unit === 'ml'){ cost = (price/1000) * qty; }
    else { cost = price * qty; }
  }
  it.calculated = Math.round(cost*100)/100;
  const el = document.getElementById('cost_'+idx); if(el) el.textContent = (it.calculated||0).toFixed(2) + ' ‚Ç∫';
}

function calculateTotal(){ let t=0; calcItems.forEach((_,i)=>{ calculateRow(i); t += parseFloat(calcItems[i].calculated||0); }); document.getElementById('totalCost').textContent = t.toFixed(2) + ' ‚Ç∫'; return t; }

/* save, preview, saved list (kept unchanged) */
function saveSnapshot(){ const name = (document.getElementById('calcName').value || currentProduct || 'ƒ∞simsiz √úr√ºn').trim(); const total = calculateTotal(); const snap = { name, total, date: new Date().toLocaleString(), items: JSON.parse(JSON.stringify(calcItems)), emoji: (currentProduct && RECIPES[currentProduct] && RECIPES[currentProduct].emoji) ? RECIPES[currentProduct].emoji : '' }; savedListArr.unshift(snap); localStorage.setItem('maliq_saved', JSON.stringify(savedListArr)); alert('Kaydedildi.'); renderSaved(); }
function renderSaved(){ const savedListEl = document.getElementById('savedList'); savedListEl.innerHTML=''; if(!savedListArr || savedListArr.length===0){ savedListEl.innerHTML = '<div class="small-note">Hen√ºz kayƒ±tlƒ± maliyet yok</div>'; return; } savedListArr.forEach((s,i)=>{ const el=document.createElement('div'); el.className='saved-item'; el.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center;font-weight:700"><div>${s.emoji? s.emoji+' ':''}${s.name}</div><div style="color:var(--accent1)">${s.total.toFixed(2)} ‚Ç∫</div></div><div class="small-note">${s.date}</div>`; const actions=document.createElement('div'); actions.className='saved-actions'; const bEdit=document.createElement('button'); bEdit.className='btn-primary'; bEdit.textContent='D√ºzenle'; bEdit.addEventListener('click', ()=>{ calcItems = JSON.parse(JSON.stringify(s.items)); renderCalcItems(); setActiveTab('calc'); }); const bDel=document.createElement('button'); bDel.className='btn-ghost'; bDel.textContent='Sil'; bDel.addEventListener('click', ()=>{ if(confirm('Silinsin mi?')){ savedListArr.splice(i,1); localStorage.setItem('maliq_saved', JSON.stringify(savedListArr)); renderSaved(); } }); const bPdf=document.createElement('button'); bPdf.className='btn-ghost'; bPdf.textContent='PDF'; bPdf.addEventListener('click', ()=> previewSavedPdf(i)); actions.appendChild(bEdit); actions.appendChild(bDel); actions.appendChild(bPdf); el.appendChild(actions); savedListEl.appendChild(el); }); }

/* preview */
let lastPreviewDataUrl = null;
async function generatePreviewElement(title, items, total){
  const container = document.createElement('div'); container.style.padding='12px'; container.style.background='#fff'; container.style.color='#000'; container.style.width='800px';
  container.innerHTML = `<h2 style="margin:0">${title} ‚Äî Maliyet</h2><div style="color:#333;margin-top:6px">${new Date().toLocaleString()}</div><table style="width:100%;border-collapse:collapse;margin-top:8px"><thead><tr><th style="text-align:left;padding:6px;border-bottom:1px solid #ddd">Malzeme</th><th style="text-align:right;padding:6px;border-bottom:1px solid #ddd">Miktar</th><th style="text-align:right;padding:6px;border-bottom:1px solid #ddd">Maliyet</th></tr></thead><tbody>${items.map(it=>`<tr><td style="padding:6px;border-bottom:1px solid #eee">${it.emoji||''} ${it.name}</td><td style="padding:6px;text-align:right;border-bottom:1px solid #eee">${it.qty} ${it.unit}</td><td style="padding:6px;text-align:right;border-bottom:1px solid #eee">${(it.calculated||0).toFixed(2)} ‚Ç∫</td></tr>`).join('')}</tbody></table><div style="margin-top:12px;font-weight:700">Toplam: ${total.toFixed(2)} ‚Ç∫</div>`;
  document.body.appendChild(container);
  try{ const canvas = await html2canvas(container, {scale:2, useCORS:true, allowTaint:true}); const dataUrl = canvas.toDataURL('image/png'); return { dataUrl, canvas }; } finally { container.remove(); }
}

async function showPreviewForCurrent(){ if(!calcItems || calcItems.length===0){ alert('√ñnce hesaplama yapƒ±n'); return; } const name = (document.getElementById('calcName').value || currentProduct || 'ƒ∞simsiz').trim(); const total = calculateTotal(); document.getElementById('previewTitle').textContent = name + ' ‚Äî √ñnizleme'; document.getElementById('previewCanvas').innerHTML = '<div style="color:#666">√ñnizleme hazƒ±rlanƒ±yor...</div>'; document.getElementById('previewModal').style.display='flex'; try{ const { dataUrl } = await generatePreviewElement(name, calcItems, total); lastPreviewDataUrl = dataUrl; document.getElementById('previewCanvas').innerHTML = `<img src="${dataUrl}" alt="preview">`; } catch(err){ document.getElementById('previewCanvas').innerHTML = '<div style="color:#c00">√ñnizleme olu≈üturulamadƒ±.</div>'; console.error(err); } }
async function previewSavedPdf(i){ const snap = savedListArr[i]; if(!snap) return; document.getElementById('previewTitle').textContent = snap.name + ' ‚Äî √ñnizleme'; document.getElementById('previewCanvas').innerHTML = '<div style="color:#666">√ñnizleme hazƒ±rlanƒ±yor...</div>'; document.getElementById('previewModal').style.display='flex'; try{ const { dataUrl } = await generatePreviewElement(snap.name, snap.items, snap.total); lastPreviewDataUrl = dataUrl; document.getElementById('previewCanvas').innerHTML = `<img src="${dataUrl}" alt="preview">`; } catch(err){ document.getElementById('previewCanvas').innerHTML = '<div style="color:#c00">√ñnizleme olu≈üturulamadƒ±.</div>'; console.error(err); } }

document.getElementById('downloadPreviewBtn').addEventListener('click', async ()=>{ if(!lastPreviewDataUrl){ alert('√ñnizleme hazƒ±rlanmadƒ±'); return; } try{ const { jsPDF } = window.jspdf; const pdf = new jsPDF({ unit:'pt', format:'a4' }); const imgProps = pdf.getImageProperties(lastPreviewDataUrl); const pageWidth = pdf.internal.pageSize.getWidth() - 40; const height = imgProps.height * pageWidth / imgProps.width; pdf.addImage(lastPreviewDataUrl, 'PNG', 20, 20, pageWidth, height); const filename = (document.getElementById('previewTitle').textContent || 'maliyet').replace(/\s+/g,'_') + '.pdf'; pdf.save(filename); } catch(err){ alert('PDF indirilemedi. Konsolu kontrol edin.'); console.error(err); } finally { document.getElementById('previewModal').style.display='none'; lastPreviewDataUrl=null; } });
document.getElementById('closePreviewBtn').addEventListener('click', ()=>{ document.getElementById('previewModal').style.display='none'; lastPreviewDataUrl=null; });

// wiring tabs and init
document.getElementById('tabCategories').addEventListener('click', ()=> setActiveTab('categories'));
document.getElementById('tabProducts').addEventListener('click', ()=> setActiveTab('products'));
document.getElementById('tabCalc').addEventListener('click', ()=> setActiveTab('calc'));
document.getElementById('tabSaved').addEventListener('click', ()=> { setActiveTab('saved'); renderSaved(); });

document.getElementById('addMaterialBtn').addEventListener('click', ()=> { document.getElementById('addModal').style.display='flex'; document.getElementById('addModal').setAttribute('aria-hidden','false'); });
document.getElementById('closeAddModal').addEventListener('click', ()=> { document.getElementById('addModal').style.display='none'; document.getElementById('addModal').setAttribute('aria-hidden','true'); });
document.getElementById('confirmAdd').addEventListener('click', ()=> {
  const name = document.getElementById('addName').value.trim() || 'Yeni Malzeme';
  const qty = parseFloat(document.getElementById('addQty').value||0);
  const unit = document.getElementById('addUnit').value;
  const price = parseFloat(document.getElementById('addPrice').value||0);
  const priceUnit = document.getElementById('addPriceUnit').value;
  const koliSize = parseFloat(document.getElementById('addKoliSize').value||0);
  calcItems.push({ name, emoji:'', qty, unit, price, priceUnit, koliSize, calculated:0 });
  document.getElementById('addModal').style.display='none';
  renderCalcItems();
});
document.getElementById('addPriceUnit').addEventListener('change', e=>{ document.getElementById('addKoliRow').style.display = e.target.value==='koli' ? 'block' : 'none'; });

document.getElementById('saveBtn').addEventListener('click', ()=> saveSnapshot());
document.getElementById('clearBtn').addEventListener('click', ()=> { if(confirm('Hesaplamayƒ± temizlemek istiyor musunuz?')){ calcItems=[]; renderCalcItems(); } });
document.getElementById('exportBtn').addEventListener('click', ()=> showPreviewForCurrent());

renderCategories();
renderProducts(null);
setActiveTab('categories');
renderSaved();

setInterval(()=>{ try{ if(calcItems && calcItems.length) localStorage.setItem('maliq_draft', JSON.stringify({ name: document.getElementById('calcName').value, items: calcItems })); }catch(e){} },4000);
</script>
</body>
</html>
